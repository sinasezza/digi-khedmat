{% extends "base/base.html" %}

{% block title %}ساخت آگهی | تهاتر کالا{% endblock title %}

{% block content %}
  <h3 class="flex content-center">حداقل 1 و حداکثر 9 تصویر بارگزاری کنید.</h3>
  <form action="" method="post" id="formData" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="images" id="imagesInput" accept=".jpg,.jpeg,.png,.gif" multiple>

    {% if barter_images|length >= 1  and barter_images|length <= 9 %}
      <button type="button" id="register" class="border border-green-600 text-black py-2 px-4 rounded">ثبت</button>
      <input id="ok" type="text" hidden name="ok" value="False">
    {% else %}
      <button type="button" id="register" class="border border-black text-black py-2 px-4 rounded opacity-50 cursor-not-allowed">ثبت</button>
    {% endif %}
  </form>

  <div id="custom-controls-gallery" class="relative w-full" data-carousel="slide">
    <div class="relative h-56 overflow-hidden rounded-lg md:h-96">
      {% for image_obj in barter_images %}
        <div class="relative duration-700 ease-in-out transition-opacity" data-carousel-item>
          <img class="absolute block max-w-full h-auto -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2" src="{{ image_obj.image.url }}" alt="image-{{ image_obj.id }}" data-image-id="{{ image_obj.id }}">
          <button type="button" class="opacity-0 group-hover:opacity-100 duration-300 w-full absolute inset-x-0 top-0 flex justify-center items-end text-xl bg-zinc-400 font-bold text-black delete-button" data-image-id="{{ image_obj.id }}">حذف</button>
        </div>
      {% endfor %}
    </div>
    <div class="flex justify-center items-center pt-4">
      <button type="button" class="flex justify-center items-center me-4 h-full cursor-pointer group focus:outline-none" data-carousel-prev>
        <span class="text-gray-400 hover:text-gray-900 dark:hover:text-white group-focus:text-gray-900 dark:group-focus:text-white">
          <svg class="rtl:rotate-180 w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5H1m0 0 4 4M1 5l4-4"/>
          </svg>
          <span class="sr-only">Previous</span>
        </span>
      </button>
      <button type="button" class="flex justify-center items-center h-full cursor-pointer group focus:outline-none" data-carousel-next>
        <span class="text-gray-400 hover:text-gray-900 dark:hover:text-white group-focus:text-gray-900 dark:group-focus:text-white">
          <svg class="rtl:rotate-180 w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
          </svg>
          <span class="sr-only">Next</span>
        </span>
      </button>
    </div>
  </div>
{% endblock content %}

{% block custom_js %}

  <script>
    $(document).ready(function () {
      const input = $("#imagesInput");
      const form = $("#formData");
      const registerBtn = $("#register");
      const imageCount = {{barter_images|length}};
  
      input.on('change', (e) => {
        form.submit();
      });
  
      registerBtn.on('click', (e) => {
        e.preventDefault();
  
        if (imageCount >= 1 && imageCount <= 9) {
          $('#ok').val("True");
          form.submit();
        }
      });
  
      function deleteImage(image) {
        console.log(`image is ${image}`);
        console.log(`image value is ${image.val()}`);
      }

      let $carouselItems = $('[data-carousel-item]');
      let currentIndex = 0;
    
      $('[data-carousel-prev]').on('click', function () {
        currentIndex = (currentIndex - 1 + $carouselItems.length) % $carouselItems.length;
        showImage(currentIndex);
      });
    
      $('[data-carousel-next]').on('click', function () {
        currentIndex = (currentIndex + 1) % $carouselItems.length;
        showImage(currentIndex);
      });
    
      // Show delete button on hover
      $carouselItems.on('mouseenter', function () {
        $(this).find('.delete-button').css('opacity', 1);
      }).on('mouseleave', function () {
        $(this).find('.delete-button').css('opacity', 0);
      });
    
      // Handle delete button click
      $('.delete-button').on('click', function () {
        let imageId = $(this).data('image-id');
        deleteImage(imageId);
      });
    
      // Initial show
      showImage(currentIndex);
    
      function showImage(index) {
        $carouselItems.hide().eq(index).show();
      }
    
      function deleteImage(imageId) {
        // Perform delete action or show a confirmation modal
        console.log('Delete image with id:', imageId);
        // Add your delete logic here, e.g., AJAX request to server
        fetch(`/api/barters/delete-barter-image/${imageId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            }
        })
        .then(response => {
            if (!response.ok) {
              throw new Error('Error deleting image');
            }
            // Image deleted successfully
            $(`[data-image-id="${imageId}"]`).closest('[data-carousel-item]').remove();
            window.location.reload();
        })
        .catch(error => {
            // Error occurred while deleting the image
            console.error('Error deleting image:', error);
        });
      }
    });
  </script>
{% endblock custom_js %}
